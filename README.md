# Docker Services

A collection of Docker services for local development environment, including databases, caching, and Ubuntu-based build environments.

## Services

| Service | Image/Base | Port | Description |
|---------|------------|------|-------------|
| mysql | MySQL 8.0 | 3306 | MySQL database with optimized configuration |
| postgres | PostgreSQL 16 | 5432 | PostgreSQL database |
| mongodb | MongoDB 7 | 27017 | MongoDB document database |
| redis | Redis 8.0 | 6379 | Redis cache with I/O threading enabled |
| ubuntu22 | Ubuntu 22.04 | - | Development environment with build tools |
| ubuntu24 | Ubuntu 24.04 | - | Development environment with build tools |

## Quick Start

### 1. Initialize Environment

Run the initialization script to generate secure passwords and create the `.env` file:

```bash
./init_env.sh
```

This will:
- Generate random passwords for MySQL, PostgreSQL, MongoDB, and Redis
- Detect your local IP address
- Create `.env` file with all configurations
- Create default `.services` file

### 2. Configure Services

Edit the `.services` file to specify which services to start. Services are separated by spaces or newlines:

```bash
# Example: start only mysql and redis
echo "mysql redis" > .services

# Example: start all database services
echo "mysql postgres mongodb redis" > .services
```

### 3. Start Services

```bash
./start.sh
```

Or start specific services directly (ignores `.services` file):

```bash
./start.sh mysql redis ubuntu24
```

### 4. Stop Services

```bash
# Stop all services
./stop.sh

# Stop specific services
./stop.sh mysql redis
```

## Configuration

### Environment Variables

All configuration is stored in `.env` file (generated by `init_env.sh`). Available variables:

| Variable | Description | Default |
|----------|-------------|---------|
| SERVICE_HOST | IP address to bind services | Auto-detected local IP |
| MYSQL_ROOT_PASSWORD | MySQL root password | Generated |
| MYSQL_DATABASE | Default MySQL database | dev |
| POSTGRES_PASSWORD | PostgreSQL password | Generated |
| POSTGRES_USER | PostgreSQL username | postgres |
| POSTGRES_DB | Default PostgreSQL database | dev |
| MONGO_ROOT_USERNAME | MongoDB admin username | admin |
| MONGO_ROOT_PASSWORD | MongoDB admin password | Generated |
| REDIS_PASSWORD | Redis authentication password | Generated |
| WORKSPACE_PATH | Mount path for Ubuntu containers | ./workspace |

### MySQL Configuration

Custom MySQL configuration is in `mysql/my.cnf`. Key settings:

- Character set: utf8mb4 with utf8mb4_unicode_ci collation
- Max connections: 1000
- Timezone: Asia/Seoul (+9:00)
- InnoDB buffer pool: Auto-calculated based on host memory
- Binary logging enabled for replication/recovery
- Slow query log enabled (threshold: 2 seconds)
- Full-text search optimized (min token size: 1)

### Redis Configuration

Redis 8.0 configuration in `redis/redis.conf`. Key settings:

- I/O threading enabled (4 threads) for improved throughput
- AOF persistence with everysec fsync
- RDB snapshots enabled
- Active defragmentation enabled
- Lazy freeing enabled for better performance
- Protected mode with password authentication

### Ubuntu Development Environments

Both Ubuntu 22.04 and 24.04 images include:

- Build tools: build-essential, cmake, ninja-build
- Compilers: clang, clang-format, clang-tidy, lldb
- Python: python3, pip, venv
- Utilities: git, curl, wget, vim, htop, jq
- Libraries: libssl-dev, libcurl4-openssl-dev, libsqlite3-dev

The containers mount:
- `./workspace` (or custom path) to `/workspace`
- `~/.ssh` (read-only) for Git SSH access
- `~/.gitconfig` (read-only) for Git configuration

## Directory Structure

```
docker-services/
├── docker-compose.yml      # Service definitions
├── .env.template           # Environment variable template
├── .env                    # Environment variables (generated, git-ignored)
├── .services               # Services to start
├── .gitignore
├── init_env.sh             # Environment initialization script
├── setenv.sh               # Source environment variables
├── start.sh                # Start services
├── stop.sh                 # Stop services
├── mysql/
│   ├── my.cnf              # MySQL configuration
│   └── mysql8.Dockerfile
├── redis/
│   ├── redis.conf          # Redis configuration
│   └── redis8.Dockerfile
├── ubuntu22/
│   └── Dockerfile
└── ubuntu24/
    └── Dockerfile
```

## Usage Examples

### Connect to MySQL

```bash
# Using docker exec
docker exec -it docker-services-mysql-1 mysql -u root -p

# Using mysql client from host
mysql -h 127.0.0.1 -P 3306 -u root -p
```

### Connect to PostgreSQL

```bash
# Using docker exec
docker exec -it docker-services-postgres-1 psql -U postgres

# Using psql from host
psql -h 127.0.0.1 -p 5432 -U postgres
```

### Connect to MongoDB

```bash
# Using docker exec
docker exec -it docker-services-mongodb-1 mongosh -u admin -p

# Using mongosh from host
mongosh "mongodb://admin:PASSWORD@127.0.0.1:27017"
```

### Connect to Redis

```bash
# Using docker exec
docker exec -it docker-services-redis-1 redis-cli -a PASSWORD

# Using redis-cli from host
redis-cli -h 127.0.0.1 -p 6379 -a PASSWORD
```

### Enter Ubuntu Container

```bash
# Ubuntu 22.04
docker exec -it docker-services-ubuntu22-1 bash

# Ubuntu 24.04
docker exec -it docker-services-ubuntu24-1 bash
```

## Troubleshooting

### Services fail to start

Check if ports are already in use:

```bash
sudo lsof -i :3306  # MySQL
sudo lsof -i :5432  # PostgreSQL
sudo lsof -i :27017 # MongoDB
sudo lsof -i :6379  # Redis
```

### Permission denied errors

Ensure scripts are executable:

```bash
chmod +x *.sh
```

### Container logs

View logs for debugging:

```bash
docker compose logs mysql
docker compose logs redis
docker compose logs -f  # Follow all logs
```

### Reset everything

Remove all containers and volumes:

```bash
docker compose down -v
rm .env
./init_env.sh
```

## License

MIT
